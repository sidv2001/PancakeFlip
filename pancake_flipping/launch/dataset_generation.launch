<launch>
    <arg name="robot_model"                       default="wx250s"/>
    <arg name="robot_name"                        default="$(arg robot_model)"/>
    <arg name="base_link_frame"                   default="base_link"/>
    <arg name="use_rviz"                          default="true"/>
    <arg name="record"                            default="false"/>
    <arg name="playback"                          default="false"/>
    <arg name="bag_name"                          default=""/>
    <arg name="launch_driver"                     default="true"/>
    <arg name="use_sim"                           default="false"/>

    <arg if="$(arg record)"   name="mode_configs" value="$(find pancake_flipping)/config/record_modes.yaml"/>
    <arg if="$(arg playback)" name="mode_configs" value="$(find pancake_flipping)/config/playback_modes.yaml"/>
    
	<arg name="marker_size" default="7" />
	<arg name="max_new_marker_error" default="0.08" />
	<arg name="max_track_error" default="0.2" />
	<arg name="cam_image_topic" default="/camera/color/image_raw" />
	<arg name="cam_info_topic" default="/camera/color/camera_info" />
	<arg name="output_frame" default="/wx250s/base_link" />
    
    <arg name="show_gripper_bar"                  default="true"/>
    <arg name="show_gripper_fingers"              default="true"/>
    <arg name="external_urdf_loc"                 default=""/>
    <arg name="load_configs"                      default="true"/>

    <arg name="filters"                           default="pointcloud"/>
    <arg name="color_fps"                         default="30"/>
    <arg name="color_width"                       default="640"/>
    <arg name="color_height"                      default="480"/>
    <arg name="depth_fps"                         default="30"/>
    <arg name="depth_width"                       default="640"/>
    <arg name="depth_height"                      default="480"/>

    <arg name="filter_ns"                         default="pc_filter"/>
    <arg name="filter_params"                     default="$(find interbotix_xsarm_perception)/config/filter_params.yaml"/>
    <arg name="use_pointcloud_tuner_gui"          default="false"/>
    <arg name="enable_pipeline"                   default="$(arg use_pointcloud_tuner_gui)"/>
    <arg name="cloud_topic"                       default="/camera/depth/color/points"/>

    <arg name="tag_family"                        default="tagStandard41h12"/>
    <arg name="standalone_tags"                   default="$(find interbotix_perception_modules)/config/tags.yaml"/>
    <arg name="camera_frame"                      default="camera_color_optical_frame"/>
    <arg name="apriltag_ns"                       default="apriltag"/>
    <arg name="camera_color_topic"                default="camera/color/image_raw"/>
    <arg name="camera_info_topic"                 default="camera/color/camera_info"/>
    <arg name="armtag_ns"                         default="armtag"/>
    <arg name="ref_frame"                         default="$(arg camera_frame)"/>
    <arg name="arm_base_frame"                    default="$(arg robot_name)/$(arg base_link_frame)"/>
    <arg name="arm_tag_frame"                     default="$(arg robot_name)/ar_tag_link"/>
    <arg name="use_armtag_tuner_gui"              default="false"/>

    <arg name="load_transforms"                   default="true"/>
    <arg name="transform_filepath"                default="$(find interbotix_xsarm_perception)/config/static_transforms.yaml"/>

    <arg name="rviz_frame"                        default="$(arg robot_name)/$(arg base_link_frame)"/>
    <arg name="rvizconfig"                        default="$(find interbotix_xsarm_perception)/rviz/xsarm_perception.rviz" />


    <include if="$(arg launch_driver)" file="$(find interbotix_xsarm_control)/launch/xsarm_control.launch">
        <arg name="robot_model"                       value="$(arg robot_model)"/>
        <arg name="robot_name"                        value="$(arg robot_name)"/>
        <arg name="base_link_frame"                   value="$(arg base_link_frame)"/>
        <arg name="use_rviz"                          value="$(arg use_rviz)"/>
        <arg name="mode_configs"                      value="$(arg mode_configs)"/>
        <arg name="use_sim"                           value="$(arg use_sim)"/>
    </include>
    <include file="$(find realsense2_camera)/launch/rs_camera.launch">
        <arg name="filters"                           value="$(arg filters)"/>
        <arg name="color_fps"                         value="$(arg color_fps)"/>
        <arg name="color_width"                       value="$(arg color_width)"/>
        <arg name="color_height"                      value="$(arg color_height)"/>
        <arg name="depth_fps"                         value="$(arg depth_fps)"/>
        <arg name="depth_width"                       value="$(arg depth_width)"/>
        <arg name="depth_height"                      value="$(arg depth_height)"/>
    </include>

    <include file="$(find interbotix_perception_modules)/launch/pc_filter.launch">
        <arg name="filter_ns"                         value="$(arg filter_ns)"/>
        <arg name="filter_params"                     value="$(arg filter_params)"/>
        <arg name="enable_pipeline"                   value="$(arg enable_pipeline)"/>
        <arg name="cloud_topic"                       value="$(arg cloud_topic)"/>
        <arg name="use_pointcloud_tuner_gui"          value="$(arg use_pointcloud_tuner_gui)"/>
    </include>

    <node pkg="tf2_ros" type="static_transform_publisher" name="camera_link_broadcaster"
        args="1.22732 0.02 0.607188   -0.00887947 0.70425 -0.00487402 0.70988 wx250s/base_link camera_link" />

	<node name="ar_track_alvar" pkg="ar_track_alvar" type="individualMarkersNoKinect" respawn="false" output="screen">
		<param name="marker_size"           type="double" value="$(arg marker_size)" />
		<param name="max_new_marker_error"  type="double" value="$(arg max_new_marker_error)" />
		<param name="max_track_error"       type="double" value="$(arg max_track_error)" />
		<param name="output_frame"          type="string" value="$(arg output_frame)" />

		<remap from="camera_image"  to="$(arg cam_image_topic)" />
		<remap from="camera_info"   to="$(arg cam_info_topic)" />
	</node>

    <group if="$(arg record)">
        <node
        name="clean_publisher"
        pkg="pancake_flipping"
        type="clean_pub"
        respawn="false"
        output="screen"
        ns="$(arg robot_name)">
        </node>

        <node
        name="rosbag_record_commands"
        pkg="rosbag"
        type="record"
        args="record -O $(find pancake_flipping)/bag/$(arg bag_name).bag /$(arg robot_name)/clean_cmds/joint_group /$(arg robot_name)/clean_cmds/joint_single /$(arg robot_name)/joint_states ar_pose_marker"/>
    </group>

    <group if="$(arg playback)">
        <node
        name="noisy_publisher"
        pkg="pancake_flipping"
        type="noisy_pub"
        respawn="false"
        output="screen"
        ns="$(arg robot_name)">
        </node>
        <node 
        name="rosbag_play_commands"
        pkg="rosbag"
        type="play"
        args="-d 3.0 $(find pancake_flipping)/bag/$(arg bag_name).bag"/>
    </group>


</launch>
